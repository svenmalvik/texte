# Hvordan Sopra Steria drifter NAV vedtak.
**Foreldrepengeprosjektet er en del av Prosjekt 2 i moderniseringen av IKT i NAV. Målet med prosjektet er å lage en moderne saksbehandlingsløsning og nye digitale tjenester, med vekt på forenkling, digitalisering og automatisering. I dette innlegget vil jeg fortelle om hvordan vi jobber og drifter løsningen og tjenestene i dag.**

Vi startet høst 2016 med å lage en prototype som jeg likte å kalle for ’hobby-prosjekt’. Det betydde ikke at vi ikke tok det på alvor, tvert imot. I stedet for å sette alt på plass for en stor applikasjon som ikke fantes enda, forholdte vi oss til det som var i dag, et lite program som ville vokse. Vår oppgave i driftsteamet var å holde applikasjonen produksjonsklar. Vi måtte sørge for at alle endringer i kodebasen øyeblikkelig blir verifisert, og utviklere fortest mulig får tilbakemelding om eventuelle feil.

Det første vi satte opp var en Jenkins Pipeline. Pipelinen skulle være enkel og forståelig. Den har derfor kun tre steg: Init, Build, Deploy. Siste steget deployer applikasjonen til en JBoss server. Når løsningen er bygget og deployet, vil det det neste verifiserte bygget overstyre det gamle. En ny versjon skal altså ikke testes manuelt og øyeblikkelig. Men, hvorfor deployer vi løsningen hvis vi ikke tester den med en gang? Det hender at ny innførte tredjeparts-biblioteker som allerede kommer med JBoss, men i en annen versjon, skaper oppstartsproblemer for løsningen. Vi opplevde dette med jaxrs og flere andre bibliotheker. Slike avhengighetsproblemer må identifiseres før vi tester manuelt. Avhengighetsproblemer med JBoss var ikke det eneste som vi måtte identifisere før vi tester.

Vi bruker Flyway. Vi sletter basen og kjører alle databaseskriptene i vårt testmiljø. Hos kunden sletter vi ikke basen. Der kjører Flyway kun nye skripter. Detter vil feile pga to ting. 1. checksummen er annerledes. 2. Eventuele avhengigheter brekkes.

Vi måtte også passe på at endringer i datamodellen ikke ødelegger eksiterende testdataer i systemtestmiljøet til kunden. For eksempel: En tabell <Person> med tre kolonner „ID“, „FORNAVN“ og "NAVN". Prosjektet bestemmer senere at kolonne NAVN skal gjøres om til ETTERNAVN. En snarvei som i noen tillfeller ble tatt var å endre kolonnenavnet i det skriptet som oppretter tabellen.  
  Eksisterende testdataer må nå migreres til den nye datamodellen. I dette eksempelet skal vi splitte "NAVN" i "FORNAVN" og "ETTERNAVN". Egentlig ikke noe stor sak. Utfordringen kom da datamodellen ble større. 
  Et endret skript kan feile når vi deployer til kundens systemtestmiljø. I verste fall kan systemet komme i en tilstand hvor det kreves mye rydding i etterkant.
  
Måten vi sørger på at slike feil oppdages tidlig er ved å deploye datamodellen som allerde ble levert til kunden først. Vi etterligner kundens systemtestmiljø før vi deployer. Vi baserer en database-deploy altså alltid på den forrige leveransen. Etterpå deployer vi våre datamodellendringer som inneholder endringer og migreringer. 
Kvalitet og stabilitet er kjempe viktig. Det gjelder hovedsakelig kodebasen. Vi bruker SonarQube og kjører kodebasen regelmessig fra Jenkins gjennom en scan. Vi gjør dette på morgenen, ved lunsjtid og på ettermiddagen. Eventuelle funn blir automatisk assignet til utviklerne og en mail blir sendt ut.

Etterhvert vi ble flere utviklere og løsningen vokste, fikk vi nye utfordringer. Hovedbranchen, det er develop-branchen, feilet oftere og manuelle testscenarioer tok mer tid enn planlagt. Vi valgte en annen branchingstrategi for å sikre bedre stabilitet. Hittil hadde alle pushet til develop-branchen, og kun noen valgte feature-branches. Vår 2017 gikk hele prosjektet over til feature-branches. Disse blir testet grundig før de blir merget inn til develop-branchen. Allikevel brekker den fortsatt inn i blant, men langt i fra så ofte som før.

De tre første måneder gikk veldig fort, og vi brukte tiden til å lære om NAV og deres verktøy. Jeg er fortsatt fasinert over det NAV IKT har oppnådd de siste årene med sine selvbetjeningssystemer. For meg var det naturlig å bestille en server med JBoss på og så vente i noen uker. I NAV rekker man ikke en gang å hente kaffe. Selvbetjeningssystemet gjør oss uavhengig fra de som drifter infrastrukturen i NAV. 
Ett år etter vi hadde startet å lage prototypen flyttet Docker, Kubernetes og noen andre verktøy som til sammen ble døpt for NAIS (NAV Application Infrastructure Service - nais.io), inn i NAV sine kontorer. Med dem kom ett sterkt ønske om færre miljøer. Hittil kunne alle jobbe på hver sin feature-branch og teste i hvert sitt miljø, helt uavhengig fra hverandre. Fra nå av skulle vi helst teste i ett og samme miljø, noe som vi viste ville skape en ustabil develop-branch. For oss betydde det at vi måtte release oftere, minst en gang i døgnet. I DevOps-verden høres det ikke uvanlig ut, og teknisk sett er det ingenting i veien med det. Vårt problem er at vi er mange, rundt 30-40 stykker, som gjør endringer på samme branchen. Å teste et system som konstant er i bevegelse er en utfordring.

## Konklusjon
De siste 16 månedene har det endret seg mye på driftssiden hos NAV og i vårt prosjekt. Kontinuerlig leveranse - DevOps - står i dag høyt på agendaen hos NAV, og både NAV og vi tilpasser oss i dag. Vi begynner å jobbe med feature toggles, kortlevende feature-branches om nødvendig i det hele tatt, og kontinuerlig manuell testing både fra vår side og fra kundens side. En prototype som først kjørte på en JBoss server har utviklet seg til et  voksent system, og det er gøy og lærerikt å følge prosjektet hele veien.
