# Hvordan Sopra Steria drifter NAVs største IT-prosjekt. 

**Foreldrepengeprosjektet er en del av Prosjekt 2 i moderniseringen av IKT i NAV. Målet med prosjektet er å lage en moderne saksbehandlingsløsning og nye digitale tjenester, med vekt på forenkling, digitalisering og automatisering. I dette innlegget vil jeg beskrive hvordan vi drifter prosjektet.**

Vi startet med en liten prototype som jeg ofte kalte for ’hobby-prosjekt’. Det betyr ikke at vi ikke tok det på alvor, tvert imot. I stedet for å sette alt på plass for en stor løsning her og nå, forholdte vi oss til det som var i dag, et lite program som vil vokse. Vår oppgave i miljøteamet er å passe på at applikasjonen alltid er produksjonsklar. Dette går kun når alle endringene i kodebasen blir øyeblikkelig verifisert, og utviklerne får fortest mulig tilbakemelding.

En Jenkins Pipeline er det første vi har satt opp og som settes i gang etter hver endring i kodebasen. Pipelinen skulle være enkel og forståelig. Den har tre steg: Init, Build, Deploy. Siste steget deployer applikasjonen til en JBoss server. Når Jenkins er ferdig og versjonen er deployet, så overskriver neste Jenkins jobb JBoss serveren med en nyere versjon. Versjonen skal altså ikke testes manuelt, dette gjør vi senere. Det hender at ny innførte tredjeparts-biblioteker som allerede kommer med JBoss, men i en annen versjon, skaper oppstartproblemer for løsningen. Vi opplevde dette med jaxrs for eksempel. Slike avhengighetsproblemer må identifiseres før vi tester manuelt. 

Datamigrering er også del av deploy steget. Vi må sikre at endringer i datamodellen tar hensyn til det som allerede ble levert til kunden. Vi kjører først databaseskriptene fra master branchen, altså fra den forrige iterasjon. Vi sikrer at de nye databaseskriptene baserer seg på forrige leveranse, og at ingen av de skriptene som ble levert i en tidligere versjon ble endret. Når vi senere deployer til vårt akseptansetestmiljø har vi som mål å ikke rense databasen. Dette gjør vi for å kunne identifisere eventuelle datamigreringsfeil.

Ett annet viktig verktøy som vi brukte fra dag 1 av er SonarQube. Den gir oss feedback om kodekvalitet, og er også viktig for å sikre god stabilitet. Vi kjører kodebasen regelmessig gjennom SonarQube, på morningen, ved lunsjtid og på ettermiddagen. Eventuelle funn blir automatisk assignet til utviklerne og en mail blir sendt ut.

De tre første måneder gikk veldig fort, og vi brukte tiden til å lære om NAV og deres verktøy. Jeg er fortsatt fasinert over det NAV IKT har oppnådd de siste årene med sine selvbetjeningssystemer. For meg var det naturlig å bestille en server og så vente i noen uker. I NAV rekker du ikke en gang å hente kaffe. Selvbetjeningssystemet gjør oss uavhengig fra de som drifter infrastrukturen i NAV.

Etterhvert flere utviklere "jointe" oss og løsningen vokste fikk vi nye utfordringer. Hovedbranchen feilet oftere og våre manuelle tester tok ofte mer tid enn planlagt. Vi valgte en annen branchingstrategi for å sikre bedre stabilitet. Hittil hadde alle pushet til develop branchen, og kun noen valgte feature branches. Vår 2017 gikk hele prosjektet over til feature branches som alltid ble testet før de ble merget inn til develop branchen.

I dag har vi 6 teams og alle har et dedikert miljø de kan teste i. En server med JBoss på og en Oracle database. Noen av utviklerne hadde spesielle testbehov, og trengte derfor egne miljøer. I tillegg spanderte vi våre Jenkins slaver hvert sitt miljø. Fordelen med flere miljøer er at alle kan verifisere og teste sine endringer uavhengig av hverandre. 
Og så flyttet Docker, Kubernetes og noen andre verktøy som til sammen ble døpt for NAIS (NAV Application Infrastructure Service - nais.io), inn i NAV sine kontorer. Med dem kom ett sterkt ønske om færre miljøer. I dag har vi ca. 20 miljøer og alle kan jobbe på hvert sitt feature branch i hvert sitt miljø, helt uavhengig fra andre. Fra nå av skulle vi alle jobbe i ett og samme miljø. For oss betydde det at vi måtte release oftere, minst en gang i døgnet, for at vi kunne teste alle våre endringer. I DevOps-verden høres det ikke uvanlig ut, og teknisk er det ingenting i veien med. Det som var utfordrende er at løsningen stadig var i bevegelse, og det er fortsatt uvanlig for alle. 

## Konklusjon

Både NAV og vi tilpasser oss i dag. Vi begynner å jobbe med feature toggles, kortlevende feature branches om nødvendig i det hele tatt, og kontinuerlig manuell testing. Utover det får vi enda flere automatiske tester. Kontinuerlig leveranse - DevOps - står høyt på agendaen hos NAV i dag. Det er ett ønske, men samtidig en forutsetning for at NAIS fungerer bra.
